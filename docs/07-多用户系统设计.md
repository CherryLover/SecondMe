# 多用户系统设计

## 需求背景

将 SecondMe 从单用户系统改造为多用户系统，支持：
- 邀请码注册
- 用户数据隔离
- 服务商配置全局共享

## 架构概览

```
用户注册 → 验证邀请码 → 创建用户 → 生成 JWT Token
用户登录 → 验证密码 → 生成 JWT Token
API 请求 → 验证 Token → 获取 user_id → 数据隔离查询
```

## 数据隔离策略

| 数据类型 | 隔离方式 |
|---------|---------|
| topics | user_id 字段隔离 |
| messages | 通过 topic_id 关联隔离 |
| memories | user_id 字段隔离 |
| memory_usage | 通过 memory_id 关联隔离 |
| providers | 全局共享，无需修改 |
| settings | 全局设置保持不变 |
| ChromaDB | 使用 user_id 作为 metadata 过滤 |

---

## 一、数据库设计

### 1.1 新增表

#### users 表 - 用户表

```sql
CREATE TABLE IF NOT EXISTS users (
    id TEXT PRIMARY KEY,
    username TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'user' CHECK(role IN ('admin', 'user')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
```

字段说明：
- `id`: UUID 主键
- `username`: 用户名，唯一
- `password_hash`: bcrypt 加密后的密码
- `role`: 用户角色，admin 可管理邀请码和服务商，user 为普通用户

#### invite_codes 表 - 邀请码表

```sql
CREATE TABLE IF NOT EXISTS invite_codes (
    id TEXT PRIMARY KEY,
    code TEXT NOT NULL UNIQUE,
    max_uses INTEGER DEFAULT 1,
    used_count INTEGER DEFAULT 0,
    created_by TEXT NOT NULL,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE INDEX IF NOT EXISTS idx_invite_codes_code ON invite_codes(code);
```

字段说明：
- `code`: 邀请码字符串（8-12 位随机字符）
- `max_uses`: 最大使用次数，1 表示一次性，0 表示无限制
- `used_count`: 已使用次数
- `expires_at`: 过期时间，NULL 表示永不过期

#### invite_code_usage 表 - 邀请码使用记录

```sql
CREATE TABLE IF NOT EXISTS invite_code_usage (
    id TEXT PRIMARY KEY,
    invite_code_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (invite_code_id) REFERENCES invite_codes(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 1.2 修改表

#### topics 表 - 添加 user_id

```sql
-- 新表结构
CREATE TABLE IF NOT EXISTS topics (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    title TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_topics_user_id ON topics(user_id);
CREATE INDEX IF NOT EXISTS idx_topics_user_updated ON topics(user_id, updated_at DESC);
```

#### memories 表 - 添加 user_id

```sql
-- 新表结构
CREATE TABLE IF NOT EXISTS memories (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    content TEXT NOT NULL,
    source TEXT NOT NULL CHECK(source IN ('chat', 'manual')),
    source_topic_id TEXT,
    source_message_id TEXT,
    use_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (source_topic_id) REFERENCES topics(id) ON DELETE SET NULL,
    FOREIGN KEY (source_message_id) REFERENCES messages(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS idx_memories_user_id ON memories(user_id);
```

---

## 二、API 设计

### 2.1 新增认证 API

| 方法 | 端点 | 描述 |
|------|------|------|
| POST | `/api/auth/register` | 用户注册（需邀请码） |
| POST | `/api/auth/login` | 用户登录 |
| GET | `/api/auth/me` | 获取当前用户信息 |
| PUT | `/api/auth/password` | 修改密码 |

#### POST /api/auth/register

请求体：
```json
{
    "username": "string",
    "password": "string",
    "invite_code": "string"
}
```

响应：
```json
{
    "access_token": "string",
    "token_type": "bearer",
    "user": {
        "id": "string",
        "username": "string",
        "role": "user",
        "created_at": "string"
    }
}
```

#### POST /api/auth/login

请求体：
```json
{
    "username": "string",
    "password": "string"
}
```

响应：同注册

### 2.2 新增管理员 API

| 方法 | 端点 | 描述 |
|------|------|------|
| POST | `/api/admin/invite-codes` | 创建邀请码 |
| GET | `/api/admin/invite-codes` | 获取邀请码列表 |
| DELETE | `/api/admin/invite-codes/{id}` | 删除邀请码 |
| GET | `/api/admin/users` | 获取用户列表 |
| DELETE | `/api/admin/users/{id}` | 删除用户 |

#### POST /api/admin/invite-codes

请求体：
```json
{
    "max_uses": 1,
    "expires_days": null
}
```

响应：
```json
{
    "id": "string",
    "code": "ABC12345",
    "max_uses": 1,
    "used_count": 0,
    "expires_at": null,
    "created_at": "string"
}
```

### 2.3 需修改的 API

以下 API 需要添加 JWT 认证：

**Topics API**（添加认证 + user_id 过滤）
- `POST /api/topics`
- `GET /api/topics`
- `GET /api/topics/{id}`
- `PATCH /api/topics/{id}`
- `DELETE /api/topics/{id}`

**Messages API**（添加认证 + 验证 topic 归属）
- `GET /api/topics/{id}/messages`
- `POST /api/topics/{id}/messages`
- `POST /api/topics/{id}/messages/stream`

**Memories API**（添加认证 + user_id 过滤）
- `GET /api/memories`
- `GET /api/memories/{id}`
- `POST /api/memories`
- `PUT /api/memories/{id}`
- `DELETE /api/memories/{id}`

**Providers API**（管理员权限）
- `POST /api/providers` - 需管理员
- `PUT /api/providers/{id}` - 需管理员
- `DELETE /api/providers/{id}` - 需管理员
- `GET /api/providers` - 所有登录用户可访问
- `GET /api/providers/{id}/models` - 所有登录用户可访问

**Settings API**
- `PUT /api/settings` - 需管理员
- `GET /api/settings` - 所有登录用户可访问

---

## 三、认证机制

### 3.1 JWT Token

- 算法：HS256
- 有效期：7 天（可配置）
- Payload：
  ```json
  {
      "user_id": "string",
      "role": "admin|user",
      "exp": 1234567890
  }
  ```

### 3.2 密码加密

使用 bcrypt 加密，自动处理盐值。

### 3.3 认证流程

```
请求 → Authorization: Bearer <token>
     → 解码 JWT
     → 验证有效期
     → 提取 user_id 和 role
     → 注入到请求上下文
```

---

## 四、新增文件

| 文件 | 用途 |
|------|------|
| `server/auth.py` | JWT 认证、密码加密、FastAPI 依赖 |
| `web/login.html` | 登录/注册页面 |
| `web/js/auth.js` | 前端认证逻辑 |
| `web/css/auth.css` | 登录页样式 |

---

## 五、配置项

### 5.1 新增环境变量

```env
# JWT 配置
JWT_SECRET=your-secure-secret-key
JWT_EXPIRE_HOURS=168

# 首次启动管理员账号
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-password
```

### 5.2 新增依赖

```
bcrypt==4.1.2
PyJWT==2.8.0
```

---

## 六、实现步骤

### 阶段一：后端认证基础

1. 添加依赖 (bcrypt, PyJWT)
2. 创建 `server/auth.py`
3. 修改 `database.py` 添加用户表和邀请码表
4. 修改 `models.py` 添加认证模型
5. 修改 `config.py` 添加 JWT 配置
6. 修改 `main.py` 添加认证路由
7. 初始化创建默认管理员

### 阶段二：数据隔离

1. 修改 `database.py` topics/memories 表结构添加 user_id
2. 修改相关 CRUD 函数添加 user_id 参数
3. 修改 `memory.py` ChromaDB 添加 user_id 元数据过滤
4. 修改 `main.py` 所有 API 添加认证依赖

### 阶段三：管理功能

1. 添加邀请码管理 API
2. 添加用户管理 API
3. providers/settings 权限控制

### 阶段四：前端改造

1. 创建 `login.html` 登录页
2. 创建 `auth.js` 认证逻辑
3. 修改 `api.js` 添加 Token 管理
4. 修改 `app.js` 登录状态检查
5. 修改 `index.html` 用户信息显示

---

## 七、安全建议

1. **JWT Secret**: 生产环境必须使用强随机密钥（至少 32 位）
2. **密码策略**: 建议添加密码强度验证（最少 8 位）
3. **HTTPS**: 生产环境必须使用 HTTPS
4. **速率限制**: 登录 API 建议添加速率限制，防止暴力破解
