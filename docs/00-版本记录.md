# SecondMe - 版本记录

## v1.0.0 (2025-12-13)

基础版本，实现核心对话和记忆功能。

### 发布日志

🎉 **SecondMe 首个版本发布！**

这是一个带有长期记忆能力的 AI 对话助手。主要特性：

- **智能对话**：支持多轮对话，AI 能够记住历史上下文
- **长期记忆**：基于向量数据库的记忆系统，跨话题检索相关历史
- **流式输出**：打字机效果，实时显示 AI 回复
- **多服务商**：支持 OpenAI、DeepSeek、SiliconFlow 等兼容 OpenAI API 的服务商
- **记忆管理**：查看、编辑、删除记忆，追踪记忆使用情况
- **环境配置**：支持 .env 文件配置，启动即用

技术栈：FastAPI + SQLite + ChromaDB + 原生 JavaScript

### 前端功能

#### 话题管理
- [x] 新建话题
- [x] 话题列表
- [x] 切换话题
- [x] 删除话题
- [x] 话题标题自动生成

#### 对话功能
- [x] 发送消息
- [x] 接收回复
- [x] 流式输出（打字机效果）
- [x] 聊天记录
- [x] 选择服务商/模型

#### 服务商管理
- [x] 添加服务商
- [x] 服务商列表
- [x] 编辑服务商
- [x] 删除服务商
- [x] 拉取模型列表
- [x] 设置默认服务商/模型

#### 记忆管理
- [x] 记忆列表
- [x] 使用统计
- [x] 使用详情
- [x] 添加记忆
- [x] 删除记忆
- [x] 编辑记忆

### 后端 API

#### 话题接口
- [x] POST /api/topics - 创建话题
- [x] GET /api/topics - 话题列表
- [x] GET /api/topics/{id} - 获取话题
- [x] PATCH /api/topics/{id} - 更新标题
- [x] DELETE /api/topics/{id} - 删除话题

#### 消息接口
- [x] GET /api/topics/{id}/messages - 消息列表
- [x] POST /api/topics/{id}/messages - 发送消息（同步）
- [x] POST /api/topics/{id}/messages/stream - 发送消息（流式）

#### 服务商接口
- [x] POST /api/providers - 添加服务商
- [x] GET /api/providers - 服务商列表
- [x] PUT /api/providers/{id} - 更新服务商
- [x] DELETE /api/providers/{id} - 删除服务商
- [x] GET /api/providers/{id}/models - 模型列表

#### 记忆接口
- [x] GET /api/memories - 记忆列表
- [x] GET /api/memories/{id} - 记忆详情
- [x] POST /api/memories - 添加记忆
- [x] PUT /api/memories/{id} - 更新记忆
- [x] DELETE /api/memories/{id} - 删除记忆

#### 配置接口
- [x] GET /api/settings - 获取配置
- [x] PUT /api/settings - 更新配置

### 后端功能

#### AI 功能
- [x] 对话生成
- [x] 标题生成
- [x] 记忆注入 prompt
- [x] 文本向量化

#### 记忆系统
- [x] 向量化存储（ChromaDB）
- [x] 相似度检索
- [x] 跨话题检索
- [x] 使用记录追踪

### 工程化

- [x] .env 环境配置
- [x] 启动时自动创建 Provider
- [x] 日志系统（控制台 + 文件）
- [x] .gitignore 配置

---

## v1.1.0 (2025-12-13)

> 记忆系统优化：从"存储所有消息"改为"智能提炼有价值的记忆"

### 相关文档

- [07-记忆提炼系统设计.md](./07-记忆提炼系统设计.md) - 完整设计方案
- [06-记忆系统设计.md](./06-记忆系统设计.md) - 原有记忆系统（v1）

### 发布日志

**记忆提炼系统上线！**

本版本对记忆系统进行了重大优化，从"存储每条消息"改为"智能提炼有价值的记忆"。

主要特性：
- **后台静默提炼**：对话静默 N 分钟后自动分析，提取有价值的记忆
- **AI 智能筛选**：只记忆个人信息、偏好习惯、重要事实、计划决定等有长期价值的内容
- **自动去重更新**：与已有记忆对比，避免重复，支持更新已有记忆
- **记忆类型标签**：记忆列表显示类型标签（个人信息/偏好习惯/重要事实/计划决定）
- **可配置参数**：支持配置静默时间、是否启用、上下文消息数
- **全部删除功能**：记忆管理新增"全部删除"按钮，方便清空测试

### 功能概述

**问题背景**
- 当前每条消息都存储为记忆，包括无意义的闲聊
- 信息碎片化，缺乏完整语义
- 记忆质量参差不齐

**解决方案**
- 后台静默提炼：话题静默 N 分钟后自动分析对话
- AI 智能提取：只记忆有长期价值的信息
- 自动去重更新：与已有记忆对比，避免重复

### 功能清单

#### 数据库变更
- [x] topics 表新增 `last_active_at` 字段（最后活跃时间）
- [x] topics 表新增 `memory_processed_at` 字段（记忆处理时间）
- [x] topics 表新增 `last_processed_message_id` 字段（上次处理到的消息ID）
- [x] memories 表新增 `memory_type` 字段（personal/preference/fact/plan/manual）
- [x] 编写数据库迁移逻辑

#### 配置项
- [x] 新增 `memory_silent_minutes` 配置（静默时间，默认 2 分钟）
- [x] 新增 `memory_extraction_enabled` 配置（是否启用提炼）
- [x] 新增 `memory_context_messages` 配置（上下文消息数，默认 6）
- [x] 更新 settings API 支持新配置项

#### 核心功能
- [x] 创建 `server/extraction.py` 记忆提炼模块
- [x] 实现后台定时任务（每 30 秒检查）
- [x] 实现查找待处理话题逻辑
- [x] 实现获取未处理消息逻辑
- [x] 实现获取上下文消息逻辑
- [x] 实现 AI 提炼 Prompt
- [x] 实现提炼结果解析（新增/更新/跳过）
- [x] 实现搜索相关已有记忆（用于去重）

#### 集成改造
- [x] 修改 `send_message()` - 移除旧的记忆存储，新增更新活跃时间
- [x] 修改 `send_message_stream()` - 同上
- [x] 启动时初始化后台任务
- [x] 优雅关闭后台任务

#### 前端适配
- [x] 设置页面新增记忆提炼配置项
- [x] 记忆列表显示记忆类型标签

#### 测试验证
- [ ] 测试静默检测逻辑
- [ ] 测试提炼质量（有价值 vs 无价值对话）
- [ ] 测试去重逻辑
- [ ] 测试更新逻辑
- [ ] 测试错误处理（提炼失败不影响对话）

### 涉及文件

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `server/database.py` | 修改 | 新增字段、迁移逻辑、记忆提炼相关函数 |
| `server/main.py` | 修改 | 移除旧记忆存储、集成后台任务、更新 settings API |
| `server/config.py` | 修改 | 新增默认配置项 |
| `server/models.py` | 修改 | 新增 Pydantic 模型字段 |
| `server/extraction.py` | **新增** | 记忆提炼模块（后台任务、AI 提炼） |
| `web/index.html` | 修改 | 新增记忆提炼设置表单 |
| `web/js/app.js` | 修改 | 处理新设置项的读取和保存 |
| `web/js/ui.js` | 修改 | 渲染记忆类型标签 |
| `web/css/style.css` | 修改 | 新增记忆类型标签样式 |

---

## v1.2.0

> 上下文限制 + Flowmo 随想记录

### 相关文档

- [08-上下文消息限制.md](./08-上下文消息限制.md) - 上下文消息数量限制
- [09-Flowmo随想记录.md](./09-Flowmo随想记录.md) - Flowmo 功能设计

### 功能概述

**功能一：上下文消息限制**
- 限制发送给 AI 的历史消息数量，避免超出模型上下文窗口
- 通过环境变量 `MAX_CONTEXT_MESSAGES` 配置，默认 100 条

**功能二：Flowmo 随想记录**
- 专门的 Flowmo 话题，用于记录碎片化的想法、情绪、感慨
- 基于时间间隔自动判断是否记录（≥5 分钟自动记录）
- AI 以倾听陪伴的风格回应
- 独立的 Flowmo 列表页面，可查看、删除、直接添加
- Flowmo 内容向量化，对话时可检索

### 功能清单

#### 功能一：上下文消息限制

- [x] `server/config.py` 新增 `MAX_CONTEXT_MESSAGES` 配置（默认 100）
- [x] `server/main.py` 修改 `send_message()` 截取最近 N 条消息
- [x] `server/main.py` 修改 `send_message_stream()` 截取最近 N 条消息

#### 功能二：Flowmo - 数据库

- [x] `topics` 表新增 `is_flowmo` 字段
- [x] 新增 `flowmos` 表
- [x] 新增 `create_flowmo()` 函数
- [x] 新增 `get_flowmos()` 函数（分页）
- [x] 新增 `delete_flowmo()` 函数
- [x] 新增 `delete_all_flowmos()` 函数
- [x] 新增 `get_or_create_flowmo_topic()` 函数
- [x] 新增 `get_last_message_time()` 函数（获取话题最后一条消息时间）

#### 功能二：Flowmo - 后端 API

- [x] 新增 `GET /api/flowmo/topic` - 获取或创建 Flowmo 话题
- [x] 新增 `GET /api/flowmos` - Flowmo 列表
- [x] 新增 `POST /api/flowmos` - 直接添加 Flowmo
- [x] 新增 `DELETE /api/flowmos/{id}` - 删除 Flowmo
- [x] 新增 `DELETE /api/flowmos/all` - 删除全部 Flowmo

#### 功能二：Flowmo - 消息发送逻辑

- [x] 修改 `send_message()` 检测是否 Flowmo 话题
- [x] 修改 `send_message_stream()` 检测是否 Flowmo 话题
- [x] Flowmo 话题使用专门的 System Prompt
- [x] 实现时间间隔判断逻辑（≥5 分钟自动记录）
- [x] 新 Flowmo 记录时只发当前消息给 AI（不带历史）
- [x] 继续聊天时带上这轮对话上下文
- [x] Flowmo 话题不受上下文消息限制

#### 功能二：Flowmo - 向量存储

- [x] 新增 `store_flowmo_vector()` 函数
- [x] 新增 `delete_flowmo_vector()` 函数
- [x] 修改 `search_memories()` 同时检索 memories 和 flowmos

#### 功能二：Flowmo - Pydantic 模型

- [x] 新增 `FlowmoCreate` 模型
- [x] 新增 `FlowmoResponse` 模型
- [x] 新增 `FlowmosResponse` 模型

#### 功能二：Flowmo - 前端

- [x] 侧边栏新增「Flowmo」按钮（与「新话题」并排）
- [x] 底部新增「Flowmo」图标按钮
- [x] 新增 Flowmo 列表弹窗
- [x] 新增直接添加 Flowmo 弹窗
- [x] `api.js` 新增 Flowmo API 调用
- [x] `app.js` 实现 Flowmo 话题逻辑
- [x] `ui.js` 实现 Flowmo 列表渲染
- [x] `style.css` 新增 Flowmo 相关样式

### 涉及文件

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `server/config.py` | 修改 | 新增 `MAX_CONTEXT_MESSAGES`、`FLOWMO_INTERVAL_MINUTES` |
| `server/database.py` | 修改 | 新增 flowmos 表、topics.is_flowmo、相关 CRUD |
| `server/main.py` | 修改 | 上下文截取、Flowmo API、消息发送逻辑 |
| `server/models.py` | 修改 | 新增 Flowmo 相关模型 |
| `server/memory.py` | 修改 | Flowmo 向量存储、联合检索 |
| `web/index.html` | 修改 | Flowmo 按钮、弹窗 |
| `web/js/api.js` | 修改 | Flowmo API 调用 |
| `web/js/app.js` | 修改 | Flowmo 话题和列表逻辑 |
| `web/js/ui.js` | 修改 | Flowmo 列表渲染 |
| `web/css/style.css` | 修改 | Flowmo 样式 |
