# SecondMe - 技术架构

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 提供商 (上游)                          │
│              OpenAI / DeepSeek / 其他兼容服务                │
└─────────────────────────────────────────────────────────────┘
                              ▲
                              │ OpenAI SDK (自定义 baseUrl)
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Server (后端)                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   FastAPI                            │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │    │
│  │  │ 话题管理  │  │ 消息管理  │  │    AI 服务       │   │    │
│  │  └──────────┘  └──────────┘  └──────────────────┘   │    │
│  └─────────────────────────────────────────────────────┘    │
│                              │                               │
│         ┌────────────────────┴────────────────────┐         │
│         ▼                                         ▼         │
│  ┌─────────────┐                         ┌─────────────┐    │
│  │   SQLite    │                         │  ChromaDB   │    │
│  │  话题/消息   │                         │  向量记忆    │    │
│  └─────────────┘                         └─────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              ▲
                              │ REST API
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Web (前端)                              │
│                   HTML + CSS + JavaScript                    │
└─────────────────────────────────────────────────────────────┘
```

## 后端架构

### 目录结构

```
server/
├── main.py              # FastAPI 入口，路由定义
├── config.py            # 配置管理
├── database.py          # SQLite 数据库操作
├── memory.py            # ChromaDB 向量记忆
├── ai_client.py         # AI API 调用封装
├── models.py            # Pydantic 数据模型
├── requirements.txt     # Python 依赖
└── data/
    ├── chat.db          # SQLite 数据文件
    └── chroma/          # ChromaDB 数据目录
```

### 模块职责

| 模块 | 职责 |
|------|------|
| main.py | 路由定义、请求处理、启动入口 |
| config.py | 读取配置（API Key、Base URL、Model） |
| database.py | 话题和消息的 CRUD 操作 |
| memory.py | 向量化存储、相似度检索 |
| ai_client.py | 封装 OpenAI SDK 调用 |
| models.py | 请求/响应数据结构定义 |

### 依赖清单

```
fastapi
uvicorn
openai
chromadb
pydantic
```

## 前端架构

### 目录结构

```
web/
├── index.html           # 主页面
├── css/
│   └── style.css        # 样式
└── js/
    ├── api.js           # API 调用封装
    ├── app.js           # 主逻辑
    └── ui.js            # UI 渲染
```

### 技术选择

- 纯原生 JavaScript，无框架依赖
- 使用 Fetch API 调用后端
- 简洁的 CSS 样式

## 数据流

### 发送消息流程

```
1. 用户输入消息，点击发送
2. 前端调用 POST /api/topics/{id}/messages
3. 后端接收消息：
   a. 存储用户消息到 SQLite
   b. 向量化用户消息
   c. 从 ChromaDB 检索相关记忆
   d. 构建 prompt（当前对话 + 相关记忆）
   e. 调用 AI API 获取回复
   f. 存储 AI 回复到 SQLite
   g. 向量化 AI 回复存入 ChromaDB
   h. 如果是首条消息，生成话题标题
4. 返回 AI 回复给前端
5. 前端显示回复
```

### 记忆检索流程

```
1. 将用户当前问题向量化
2. 在 ChromaDB 中搜索最相似的历史记录
3. 返回 Top-K 条相关记忆（默认 5 条）
4. 将记忆作为上下文注入 system prompt
```

## 配置管理

配置文件 `server/config.py` 或环境变量：

```python
# AI 服务配置
AI_BASE_URL = "https://api.openai.com/v1"  # 可自定义
AI_API_KEY = "your-api-key"
AI_MODEL = "gpt-3.5-turbo"  # 或其他模型

# 记忆配置
MEMORY_TOP_K = 5  # 检索返回的记忆条数
```

## 跨域处理

后端启用 CORS，允许前端跨域访问：

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)
```
