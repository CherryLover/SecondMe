# SecondMe - 数据库设计

## 概述

使用 SQLite 存储所有业务数据，文件位置：`server/data/chat.db`

## 表结构

### topics 表（话题）

```sql
CREATE TABLE topics (
    id TEXT PRIMARY KEY,           -- UUID
    title TEXT NOT NULL,           -- 话题标题
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_topics_updated_at ON topics(updated_at DESC);
```

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键，UUID 格式 |
| title | TEXT | 话题标题，AI 自动生成 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 最后更新时间 |

### messages 表（消息）

```sql
CREATE TABLE messages (
    id TEXT PRIMARY KEY,           -- UUID
    topic_id TEXT NOT NULL,        -- 所属话题
    role TEXT NOT NULL,            -- 'user' 或 'assistant'
    content TEXT NOT NULL,         -- 消息内容
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (topic_id) REFERENCES topics(id) ON DELETE CASCADE
);

CREATE INDEX idx_messages_topic_id ON messages(topic_id);
CREATE INDEX idx_messages_created_at ON messages(topic_id, created_at);
```

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键，UUID 格式 |
| topic_id | TEXT | 外键，关联 topics.id |
| role | TEXT | 角色：user / assistant |
| content | TEXT | 消息内容 |
| created_at | TIMESTAMP | 创建时间 |

### providers 表（服务商）

```sql
CREATE TABLE providers (
    id TEXT PRIMARY KEY,           -- UUID
    name TEXT NOT NULL,            -- 显示名称
    base_url TEXT NOT NULL,        -- API 地址
    api_key TEXT NOT NULL,         -- API 密钥（加密存储）
    enabled INTEGER DEFAULT 1,     -- 是否启用
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键，UUID 格式 |
| name | TEXT | 服务商名称（如 "OpenAI"） |
| base_url | TEXT | API 服务地址 |
| api_key | TEXT | API 密钥 |
| enabled | INTEGER | 是否启用：1=是，0=否 |
| created_at | TIMESTAMP | 创建时间 |

### memories 表（记忆）

```sql
CREATE TABLE memories (
    id TEXT PRIMARY KEY,           -- UUID
    content TEXT NOT NULL,         -- 记忆内容
    source TEXT NOT NULL,          -- 来源：'chat' 或 'manual'
    source_topic_id TEXT,          -- 来源话题（chat 类型）
    source_message_id TEXT,        -- 来源消息（chat 类型）
    use_count INTEGER DEFAULT 0,   -- 使用次数
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP,        -- 最后使用时间
    FOREIGN KEY (source_topic_id) REFERENCES topics(id) ON DELETE SET NULL,
    FOREIGN KEY (source_message_id) REFERENCES messages(id) ON DELETE SET NULL
);

CREATE INDEX idx_memories_source ON memories(source);
CREATE INDEX idx_memories_use_count ON memories(use_count DESC);
CREATE INDEX idx_memories_last_used ON memories(last_used_at DESC);
```

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键，UUID 格式 |
| content | TEXT | 记忆内容文本 |
| source | TEXT | 来源：chat（对话生成）/ manual（手动添加） |
| source_topic_id | TEXT | 来源话题 ID（仅 chat 类型） |
| source_message_id | TEXT | 来源消息 ID（仅 chat 类型） |
| use_count | INTEGER | 被使用次数 |
| created_at | TIMESTAMP | 创建时间 |
| last_used_at | TIMESTAMP | 最后使用时间 |

### memory_usage 表（记忆使用记录）

```sql
CREATE TABLE memory_usage (
    id TEXT PRIMARY KEY,           -- UUID
    memory_id TEXT NOT NULL,       -- 记忆 ID
    topic_id TEXT NOT NULL,        -- 使用时的话题
    message_id TEXT NOT NULL,      -- 使用时的消息（AI 回复）
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (memory_id) REFERENCES memories(id) ON DELETE CASCADE,
    FOREIGN KEY (topic_id) REFERENCES topics(id) ON DELETE CASCADE,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE
);

CREATE INDEX idx_memory_usage_memory_id ON memory_usage(memory_id);
CREATE INDEX idx_memory_usage_topic_id ON memory_usage(topic_id);
```

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键，UUID 格式 |
| memory_id | TEXT | 外键，关联 memories.id |
| topic_id | TEXT | 使用时的话题 ID |
| message_id | TEXT | 使用时的消息 ID（AI 回复） |
| used_at | TIMESTAMP | 使用时间 |

### settings 表（配置）

```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY,          -- 配置键
    value TEXT NOT NULL            -- 配置值（JSON 格式）
);
```

| 字段 | 类型 | 说明 |
|------|------|------|
| key | TEXT | 配置键名 |
| value | TEXT | 配置值（JSON 字符串） |

**预设配置项**:

| key | 说明 | 示例值 |
|-----|------|--------|
| default_chat_provider_id | 默认对话服务商 | "uuid-string" |
| default_chat_model | 默认对话模型 | "gpt-3.5-turbo" |
| embedding_provider_id | 向量化服务商 | "uuid-string" |
| embedding_model | 向量化模型 | "text-embedding-3-small" |
| memory_top_k | 记忆检索数量 | "5" |

## ER 图

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  providers  │         │   topics    │         │  messages   │
├─────────────┤         ├─────────────┤         ├─────────────┤
│ id (PK)     │         │ id (PK)     │────────<│ id (PK)     │
│ name        │         │ title       │         │ topic_id(FK)│
│ base_url    │         │ created_at  │         │ role        │
│ api_key     │         │ updated_at  │         │ content     │
│ enabled     │         └─────────────┘         │ created_at  │
│ created_at  │               │                 └─────────────┘
└─────────────┘               │                       │
                              │                       │
┌─────────────┐               │                       │
│  settings   │               │                       │
├─────────────┤               ▼                       ▼
│ key (PK)    │         ┌─────────────┐         ┌─────────────┐
│ value       │         │  memories   │         │memory_usage │
└─────────────┘         ├─────────────┤         ├─────────────┤
                        │ id (PK)     │────────<│ id (PK)     │
                        │ content     │         │ memory_id   │
                        │ source      │         │ topic_id    │
                        │ source_*    │         │ message_id  │
                        │ use_count   │         │ used_at     │
                        │ created_at  │         └─────────────┘
                        │ last_used_at│
                        └─────────────┘
```

## 初始化 SQL

```sql
-- 启用外键约束
PRAGMA foreign_keys = ON;

-- 创建话题表
CREATE TABLE IF NOT EXISTS topics (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建消息表
CREATE TABLE IF NOT EXISTS messages (
    id TEXT PRIMARY KEY,
    topic_id TEXT NOT NULL,
    role TEXT NOT NULL CHECK(role IN ('user', 'assistant')),
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (topic_id) REFERENCES topics(id) ON DELETE CASCADE
);

-- 创建服务商表
CREATE TABLE IF NOT EXISTS providers (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    base_url TEXT NOT NULL,
    api_key TEXT NOT NULL,
    enabled INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建记忆表
CREATE TABLE IF NOT EXISTS memories (
    id TEXT PRIMARY KEY,
    content TEXT NOT NULL,
    source TEXT NOT NULL CHECK(source IN ('chat', 'manual')),
    source_topic_id TEXT,
    source_message_id TEXT,
    use_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP,
    FOREIGN KEY (source_topic_id) REFERENCES topics(id) ON DELETE SET NULL,
    FOREIGN KEY (source_message_id) REFERENCES messages(id) ON DELETE SET NULL
);

-- 创建记忆使用记录表
CREATE TABLE IF NOT EXISTS memory_usage (
    id TEXT PRIMARY KEY,
    memory_id TEXT NOT NULL,
    topic_id TEXT NOT NULL,
    message_id TEXT NOT NULL,
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (memory_id) REFERENCES memories(id) ON DELETE CASCADE,
    FOREIGN KEY (topic_id) REFERENCES topics(id) ON DELETE CASCADE,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE
);

-- 创建配置表
CREATE TABLE IF NOT EXISTS settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_topics_updated_at ON topics(updated_at DESC);
CREATE INDEX IF NOT EXISTS idx_messages_topic_id ON messages(topic_id);
CREATE INDEX IF NOT EXISTS idx_messages_created_at ON messages(topic_id, created_at);
CREATE INDEX IF NOT EXISTS idx_memories_source ON memories(source);
CREATE INDEX IF NOT EXISTS idx_memories_use_count ON memories(use_count DESC);
CREATE INDEX IF NOT EXISTS idx_memories_last_used ON memories(last_used_at DESC);
CREATE INDEX IF NOT EXISTS idx_memory_usage_memory_id ON memory_usage(memory_id);
CREATE INDEX IF NOT EXISTS idx_memory_usage_topic_id ON memory_usage(topic_id);
```

## 常用查询

### 获取话题列表（按更新时间降序）

```sql
SELECT * FROM topics ORDER BY updated_at DESC;
```

### 获取话题的所有消息（按时间升序）

```sql
SELECT * FROM messages WHERE topic_id = ? ORDER BY created_at ASC;
```

### 获取启用的服务商列表

```sql
SELECT id, name, base_url, enabled, created_at
FROM providers
WHERE enabled = 1;
```

### 获取记忆列表（带使用统计）

```sql
SELECT * FROM memories ORDER BY use_count DESC, last_used_at DESC;
```

### 获取记忆的使用详情

```sql
SELECT
    mu.used_at,
    t.id as topic_id,
    t.title as topic_title,
    mu.message_id
FROM memory_usage mu
JOIN topics t ON mu.topic_id = t.id
WHERE mu.memory_id = ?
ORDER BY mu.used_at DESC;
```

### 记录记忆使用并更新统计

```sql
-- 插入使用记录
INSERT INTO memory_usage (id, memory_id, topic_id, message_id)
VALUES (?, ?, ?, ?);

-- 更新记忆统计
UPDATE memories
SET use_count = use_count + 1,
    last_used_at = CURRENT_TIMESTAMP
WHERE id = ?;
```

### 删除话题（级联删除消息和记忆使用记录）

```sql
DELETE FROM topics WHERE id = ?;
-- messages 和 memory_usage 会因为 ON DELETE CASCADE 自动删除
-- memories 的 source_topic_id 会被设为 NULL
```

### 获取配置

```sql
SELECT value FROM settings WHERE key = ?;
```

### 更新配置

```sql
INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?);
```
