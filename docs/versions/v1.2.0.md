# v1.2.0

> 上下文限制 + Flowmo 随想记录

## 相关文档

- [08-上下文消息限制.md](../08-上下文消息限制.md) - 上下文消息数量限制
- [09-Flowmo随想记录.md](../09-Flowmo随想记录.md) - Flowmo 功能设计

## 功能概述

**功能一：上下文消息限制**
- 限制发送给 AI 的历史消息数量，避免超出模型上下文窗口
- 通过环境变量 `MAX_CONTEXT_MESSAGES` 配置，默认 100 条

**功能二：Flowmo 随想记录**
- 专门的 Flowmo 话题，用于记录碎片化的想法、情绪、感慨
- 基于时间间隔自动判断是否记录（≥5 分钟自动记录）
- AI 以倾听陪伴的风格回应
- 独立的 Flowmo 列表页面，可查看、删除、直接添加
- Flowmo 内容向量化，对话时可检索

## 功能清单

### 功能一：上下文消息限制

- [x] `server/config.py` 新增 `MAX_CONTEXT_MESSAGES` 配置（默认 100）
- [x] `server/main.py` 修改 `send_message()` 截取最近 N 条消息
- [x] `server/main.py` 修改 `send_message_stream()` 截取最近 N 条消息

### 功能二：Flowmo - 数据库

- [x] `topics` 表新增 `is_flowmo` 字段
- [x] 新增 `flowmos` 表
- [x] 新增 `create_flowmo()` 函数
- [x] 新增 `get_flowmos()` 函数（分页）
- [x] 新增 `delete_flowmo()` 函数
- [x] 新增 `delete_all_flowmos()` 函数
- [x] 新增 `get_or_create_flowmo_topic()` 函数
- [x] 新增 `get_last_message_time()` 函数（获取话题最后一条消息时间）

### 功能二：Flowmo - 后端 API

- [x] 新增 `GET /api/flowmo/topic` - 获取或创建 Flowmo 话题
- [x] 新增 `GET /api/flowmos` - Flowmo 列表
- [x] 新增 `POST /api/flowmos` - 直接添加 Flowmo
- [x] 新增 `DELETE /api/flowmos/{id}` - 删除 Flowmo
- [x] 新增 `DELETE /api/flowmos/all` - 删除全部 Flowmo

### 功能二：Flowmo - 消息发送逻辑

- [x] 修改 `send_message()` 检测是否 Flowmo 话题
- [x] 修改 `send_message_stream()` 检测是否 Flowmo 话题
- [x] Flowmo 话题使用专门的 System Prompt
- [x] 实现时间间隔判断逻辑（≥5 分钟自动记录）
- [x] 新 Flowmo 记录时只发当前消息给 AI（不带历史）
- [x] 继续聊天时带上这轮对话上下文
- [x] Flowmo 话题不受上下文消息限制

### 功能二：Flowmo - 向量存储

- [x] 新增 `store_flowmo_vector()` 函数
- [x] 新增 `delete_flowmo_vector()` 函数
- [x] 修改 `search_memories()` 同时检索 memories 和 flowmos

### 功能二：Flowmo - Pydantic 模型

- [x] 新增 `FlowmoCreate` 模型
- [x] 新增 `FlowmoResponse` 模型
- [x] 新增 `FlowmosResponse` 模型

### 功能二：Flowmo - 前端

- [x] 侧边栏新增「Flowmo」按钮（与「新话题」并排）
- [x] 底部新增「Flowmo」图标按钮
- [x] 新增 Flowmo 列表弹窗
- [x] 新增直接添加 Flowmo 弹窗
- [x] `api.js` 新增 Flowmo API 调用
- [x] `app.js` 实现 Flowmo 话题逻辑
- [x] `ui.js` 实现 Flowmo 列表渲染
- [x] `style.css` 新增 Flowmo 相关样式

## 涉及文件

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `server/config.py` | 修改 | 新增 `MAX_CONTEXT_MESSAGES`、`FLOWMO_INTERVAL_MINUTES` |
| `server/database.py` | 修改 | 新增 flowmos 表、topics.is_flowmo、相关 CRUD |
| `server/main.py` | 修改 | 上下文截取、Flowmo API、消息发送逻辑 |
| `server/models.py` | 修改 | 新增 Flowmo 相关模型 |
| `server/memory.py` | 修改 | Flowmo 向量存储、联合检索 |
| `web/index.html` | 修改 | Flowmo 按钮、弹窗 |
| `web/js/api.js` | 修改 | Flowmo API 调用 |
| `web/js/app.js` | 修改 | Flowmo 话题和列表逻辑 |
| `web/js/ui.js` | 修改 | Flowmo 列表渲染 |
| `web/css/style.css` | 修改 | Flowmo 样式 |
