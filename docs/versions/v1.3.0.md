# v1.3.0

> 多用户系统：支持用户注册、登录、数据隔离

## 相关文档

- [10-多用户系统设计.md](../10-多用户系统设计.md) - 完整设计方案

## 发布日志

**多用户系统上线！**

本版本将 SecondMe 从单用户系统升级为多用户系统，支持多人独立使用。

主要特性：
- **邀请码注册**：通过管理员创建的邀请码进行注册
- **JWT 认证**：基于 JWT Token 的用户认证，支持滑动过期
- **数据隔离**：话题、消息、记忆、Flowmo 完全按用户隔离
- **管理员功能**：管理邀请码、查看用户列表、删除用户
- **服务商共享**：Provider 和 Settings 全局共享，无需重复配置

## 功能清单

### 数据库变更
- [x] 新增 `users` 表（用户表）
- [x] 新增 `invite_codes` 表（邀请码表）
- [x] 新增 `invite_code_usage` 表（邀请码使用记录）
- [x] `topics` 表新增 `user_id` 字段
- [x] `memories` 表新增 `user_id` 字段
- [x] `flowmos` 表新增 `user_id` 字段
- [x] 创建相关索引

### 认证系统
- [x] 新增 `server/auth.py` 认证模块
- [x] 实现 bcrypt 密码加密
- [x] 实现 JWT Token 生成和验证
- [x] 实现 Token 滑动过期机制
- [x] 首次启动自动创建默认管理员

### 认证 API
- [x] `POST /api/auth/register` - 用户注册（需邀请码）
- [x] `POST /api/auth/login` - 用户登录
- [x] `GET /api/auth/me` - 获取当前用户信息
- [x] `PUT /api/auth/password` - 修改密码

### 管理员 API
- [x] `POST /api/admin/invite-codes` - 创建邀请码
- [x] `GET /api/admin/invite-codes` - 邀请码列表
- [x] `DELETE /api/admin/invite-codes/{id}` - 删除邀请码
- [x] `GET /api/admin/users` - 用户列表
- [x] `DELETE /api/admin/users/{id}` - 删除用户

### API 权限改造
- [x] Topics API 添加用户认证和数据隔离
- [x] Messages API 添加用户认证和话题归属验证
- [x] Memories API 添加用户认证和数据隔离
- [x] Flowmo API 添加用户认证和数据隔离
- [x] Providers API 添加管理员权限控制
- [x] Settings API 添加管理员权限控制

### ChromaDB 改造
- [x] memories 向量存储添加 user_id 元数据
- [x] flowmos 向量存储添加 user_id 元数据
- [x] 向量检索按 user_id 过滤

### 前端改造
- [x] 新增 `login.html` 登录/注册页面
- [x] 新增 `web/js/auth.js` 前端认证逻辑
- [x] `api.js` 添加 Token 自动携带
- [x] `api.js` 添加 401 自动跳转登录
- [x] `api.js` 添加 Token 滑动刷新处理
- [x] `index.html` 添加用户信息展示
- [x] `index.html` 添加管理员入口
- [x] `app.js` 添加登出功能
- [x] `app.js` 添加管理员功能（邀请码、用户管理）

### 配置项
- [x] 新增 `JWT_SECRET` 环境变量
- [x] 新增 `JWT_EXPIRE_HOURS` 环境变量（默认 168 小时）
- [x] 新增 `ADMIN_USERNAME` 环境变量（默认 admin）
- [x] 新增 `ADMIN_PASSWORD` 环境变量（默认 admin123）
- [x] 新增 bcrypt、PyJWT 依赖

## 涉及文件

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `server/auth.py` | **新增** | JWT 认证、密码加密、FastAPI 依赖 |
| `server/config.py` | 修改 | JWT 和管理员配置 |
| `server/database.py` | 修改 | 用户表、邀请码表、数据隔离 |
| `server/main.py` | 修改 | 认证路由、权限控制、用户数据隔离 |
| `server/models.py` | 修改 | 认证相关 Pydantic 模型 |
| `server/memory.py` | 修改 | 向量存储添加 user_id |
| `server/requirements.txt` | 修改 | 新增 bcrypt、PyJWT |
| `server/.env.example` | 修改 | 新增配置项示例 |
| `web/login.html` | **新增** | 登录/注册页面 |
| `web/js/auth.js` | **新增** | 前端认证逻辑 |
| `web/js/api.js` | 修改 | Token 管理、401 处理 |
| `web/js/app.js` | 修改 | 登出、管理员功能 |
| `web/index.html` | 修改 | 用户信息、管理入口 |
| `web/css/style.css` | 修改 | 登录页、管理弹窗样式 |
