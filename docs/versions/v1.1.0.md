# v1.1.0 (2025-12-13)

> 记忆系统优化：从"存储所有消息"改为"智能提炼有价值的记忆"

## 相关文档

- [07-记忆提炼系统设计.md](../07-记忆提炼系统设计.md) - 完整设计方案
- [06-记忆系统设计.md](../06-记忆系统设计.md) - 原有记忆系统（v1）

## 发布日志

**记忆提炼系统上线！**

本版本对记忆系统进行了重大优化，从"存储每条消息"改为"智能提炼有价值的记忆"。

主要特性：
- **后台静默提炼**：对话静默 N 分钟后自动分析，提取有价值的记忆
- **AI 智能筛选**：只记忆个人信息、偏好习惯、重要事实、计划决定等有长期价值的内容
- **自动去重更新**：与已有记忆对比，避免重复，支持更新已有记忆
- **记忆类型标签**：记忆列表显示类型标签（个人信息/偏好习惯/重要事实/计划决定）
- **可配置参数**：支持配置静默时间、是否启用、上下文消息数
- **全部删除功能**：记忆管理新增"全部删除"按钮，方便清空测试

## 功能概述

**问题背景**
- 当前每条消息都存储为记忆，包括无意义的闲聊
- 信息碎片化，缺乏完整语义
- 记忆质量参差不齐

**解决方案**
- 后台静默提炼：话题静默 N 分钟后自动分析对话
- AI 智能提取：只记忆有长期价值的信息
- 自动去重更新：与已有记忆对比，避免重复

## 功能清单

### 数据库变更
- [x] topics 表新增 `last_active_at` 字段（最后活跃时间）
- [x] topics 表新增 `memory_processed_at` 字段（记忆处理时间）
- [x] topics 表新增 `last_processed_message_id` 字段（上次处理到的消息ID）
- [x] memories 表新增 `memory_type` 字段（personal/preference/fact/plan/manual）
- [x] 编写数据库迁移逻辑

### 配置项
- [x] 新增 `memory_silent_minutes` 配置（静默时间，默认 2 分钟）
- [x] 新增 `memory_extraction_enabled` 配置（是否启用提炼）
- [x] 新增 `memory_context_messages` 配置（上下文消息数，默认 6）
- [x] 更新 settings API 支持新配置项

### 核心功能
- [x] 创建 `server/extraction.py` 记忆提炼模块
- [x] 实现后台定时任务（每 30 秒检查）
- [x] 实现查找待处理话题逻辑
- [x] 实现获取未处理消息逻辑
- [x] 实现获取上下文消息逻辑
- [x] 实现 AI 提炼 Prompt
- [x] 实现提炼结果解析（新增/更新/跳过）
- [x] 实现搜索相关已有记忆（用于去重）

### 集成改造
- [x] 修改 `send_message()` - 移除旧的记忆存储，新增更新活跃时间
- [x] 修改 `send_message_stream()` - 同上
- [x] 启动时初始化后台任务
- [x] 优雅关闭后台任务

### 前端适配
- [x] 设置页面新增记忆提炼配置项
- [x] 记忆列表显示记忆类型标签

### 测试验证
- [ ] 测试静默检测逻辑
- [ ] 测试提炼质量（有价值 vs 无价值对话）
- [ ] 测试去重逻辑
- [ ] 测试更新逻辑
- [ ] 测试错误处理（提炼失败不影响对话）

## 涉及文件

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `server/database.py` | 修改 | 新增字段、迁移逻辑、记忆提炼相关函数 |
| `server/main.py` | 修改 | 移除旧记忆存储、集成后台任务、更新 settings API |
| `server/config.py` | 修改 | 新增默认配置项 |
| `server/models.py` | 修改 | 新增 Pydantic 模型字段 |
| `server/extraction.py` | **新增** | 记忆提炼模块（后台任务、AI 提炼） |
| `web/index.html` | 修改 | 新增记忆提炼设置表单 |
| `web/js/app.js` | 修改 | 处理新设置项的读取和保存 |
| `web/js/ui.js` | 修改 | 渲染记忆类型标签 |
| `web/css/style.css` | 修改 | 新增记忆类型标签样式 |
